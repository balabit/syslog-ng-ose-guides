<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE chapter
[
<!ENTITY % entities SYSTEM "../../common/syslog-ng-entities.ent">
  %entities;]>
<chapter xml:id="chapter-destinations" xmlns="http://docbook.org/ns/docbook" version="5.0">
    <title>Configuring destinations</title>
    <indexterm>
        <primary>&agentabbrev;</primary>
        <secondary>destinations</secondary>
    </indexterm>
    <indexterm>
        <primary>&agentabbrev;</primary>
        <secondary>configuring the log server</secondary>
    </indexterm>
    <indexterm>
        <primary>destinations</primary>
        <secondary>&agentabbrev;</secondary>
    </indexterm>
    <para>The &agent; application can send the log messages of the Windows host to a central log server or relay. It is possible to send the same messages to multiple servers, when each server receives the same messages; and also to configure failover servers, when the agent sends the messages to a primary server, or to a failover server if the primary becomes unavailable. If the agent loses the connection to a destination server and the reconnection fails, it will generate an eventlog message. The successful reconnection attempt is also logged. (If the server is unavailable for a long time, the agent generates a log message about the failed connection once in every ten seconds.)</para>
    <para>If the failover server also becomes unavailable, the application will switch to the next failover server, and so on. If the last failover server is unavailable, it switches back to the primary. The application does not switch back automatically to the primary server if it becomes available again, only if the syslog-ng Agent for Windows has been restarted.</para>
    <note>
        <para>The failover servers will use the same options that the primary server uses. Only the name and the address can be configured for the failover servers.</para>
    </note>
    <para>Similarly to the Linux version, the agent now sends MARK messages to the server to indicate that the client host is alive but there are no log messages to send. A MARK message is sent every ten minutes.</para>
    <warning>
        <para>The &agent; application does not support the unreliable UDP protocol. Configure your central log server to accept logs using TCP or TLS connections. If needed, adjust your firewall configuration to permit such traffic to the log server.</para>
    </warning>
    <figure>
        <title>Adding new destinations</title>
        <mediaobject>
            <imageobject role="html">
                <imagedata format="PNG" fileref="win-destinations.png"/>
            </imageobject>
            <imageobject role="fo">
                <imagedata format="PNG" fileref="&imgroot;/win-destinations.png" contentwidth="&screenshotsize;"/>
            </imageobject>
        </mediaobject>
    </figure>
    <procedure xml:id="windows-configure-destination">
        <title>Configuring the destination log servers</title>
        <formalpara>
            <title>Purpose:</title>
            <para/>
        </formalpara>
        <para>To configure a new destination, complete the following steps:</para>
        <formalpara>
            <title>Steps:</title>
            <para/>
        </formalpara>
        <step>
            <para>Start the configuration interface of the &agent; application.</para>
        </step>
        <step>
            <para>Select <guimenu>syslog-ng Agent Settings > Destinations</guimenu>, and double-click on <guimenu>Add new server</guimenu>.</para>
        </step>
        <step>
            <para>Enter the hostname or the IP address of the log server into the <guimenu>Server Name or Address (IPv4)</guimenu> field. If your log server is configured to accept messages on a non-standard port, type the port number into the <guimenu>Server Port</guimenu> field. To use the default port (<parameter>35514</parameter> when <trademark>RLTP</trademark> is enabled and <parameter>514</parameter> when <trademark>RLTP</trademark> is disabled), click <guimenu>Reset to Default Port</guimenu>.</para>
            <para>To enable flow-control, select <guimenu>Enable flow-control</guimenu>. For details, see <xref linkend="windows-agent-flow-control"/>.</para>
            <para>To use SSL encryption, enable <guimenu>Use SSL encryption</guimenu>. For details, see <xref linkend="chapter-ssl"/>.</para>
            <figure>
                <title>Adding new server</title>
                <mediaobject>
                    <imageobject role="html">
                        <imagedata format="PNG" fileref="win-server-property-server.png"/>
                    </imageobject>
                    <imageobject role="fo">
                        <imagedata format="PNG" fileref="&imgroot;/win-server-property-server.png" contentwidth="10cm"/>
                    </imageobject>
                </mediaobject>
            </figure>
        </step>
        <step>
            <para><emphasis>Optional Step</emphasis>: To use the <trademark>Reliable Log Transfer Protocol</trademark> (<trademark>RLTP</trademark>), enable <guimenu>Use syslog-ng proprietary Reliable Log Transfer Protocol (RLTP)</guimenu>. For details on the concepts of <trademark>RLTP</trademark>, see <olink targetdoc="syslog-ng-pe-guide-admin" targetptr="chapter-rltp"/>.</para>
            <xi:include href="../../common/wnt/note-windows-agent-rltp-flowcontrol.xml" xmlns:xi="http://www.w3.org/2001/XInclude"/>
            <substeps>
                <step>
                    <para>Click <guimenu>Advanced Options</guimenu>.</para>
                </step>
                <step>
                    <para>Change the following options if necessary:</para>
                    <note>
                        <para>Do not adjust or modify the following settings unless you know exactly what you are doing.</para>
                    </note>
                    <itemizedlist>
                        <listitem>
                            <para><guimenu>Transaction Size</guimenu>: The number of messages sent before waiting for acknowledgement from the server.</para>
                        </listitem>
                        <listitem>
                            <para><guimenu>Response Timeout</guimenu>: After not receiving any message in the given timeframe, &agentabbrev; terminates the connection with the server.</para>
                        </listitem>
                        <listitem>
                            <para><guimenu>Acknowledge Timeout</guimenu>: After not receiving any reply to the messages in the given timeframe, &agentabbrev; terminates the connection with the server.</para>
                        </listitem>
                    </itemizedlist>
                </step>
                <step>
                    <para>Click <guimenu>OK</guimenu>.</para>
                </step>
            </substeps>
        </step>
        <step>
            <para>On <guimenu>Messages</guimenu> tab, select the protocol used to transfer log messages and press <guimenu>Reset</guimenu> to apply the selected template. The following protocol templates are available (for details on the default templates and on customizing the message format, see <xref linkend="chapter-format"/>):</para>
            <itemizedlist>
                <listitem>
                    <indexterm>
                        <primary>BSD-syslog protocol</primary>
                    </indexterm>
                    <indexterm>
                        <primary>Legacy-syslog protocol</primary>
                    </indexterm>
                    <indexterm>
                        <primary>RFC 3164</primary>
                    </indexterm>
                    <para><guimenu>Legacy BSD Syslog Protocol</guimenu>: Use the legacy BSD-syslog protocol specified in RFC3164. This option uses the following message template: <parameter>&lt;${PRI}&gt;${BSDDATE} ${HOST} ${MSGHDR}${MESSAGE}</parameter>. Within the message part, &agentabbrev; replaces CRLF with 2 spaces and TAB character with 1 space.</para>
                    <figure>
                        <title>Legacy BSD Syslog Protocol</title>
                        <mediaobject>
                            <imageobject role="html">
                                <imagedata format="PNG" fileref="win-legacy-bsd-syslog-protocol.png"/>
                            </imageobject>
                            <imageobject role="fo">
                                <imagedata format="PNG" fileref="&imgroot;/win-legacy-bsd-syslog-protocol.png" contentwidth="10cm"/>
                            </imageobject>
                        </mediaobject>
                    </figure>
                    <example xml:id="example-legacy-bsd">
                        <title>Legacy BSD Syslog Protocol log</title>
                        <synopsis>&lt;134&gt;Oct 04 14:45:33 zts-win019.ztswin2008dom.balabit Microsoft-Windows-Eventlog[2880]: ZTSWIN2008DOM\balabit: System Microsoft-Windows-Eventlog: [Information] The Application log file was cleared. (EventID 104)</synopsis>
                    </example>
                </listitem>
                <listitem>
                    <indexterm>
                        <primary>syslog protocol</primary>
                    </indexterm>
                    <indexterm>
                        <primary>IETF-syslog protocol</primary>
                    </indexterm>
                    <indexterm>
                        <primary>RFC 5424-5426</primary>
                    </indexterm>
                    <para><guimenu>Syslog Protocol</guimenu>: Use the new IETF-syslog protocol specified in <link xmlns:ns1="http://www.w3.org/1999/xlink" ns1:href="http://tools.ietf.org/html/rfc5424">RFC 5424-5426</link>. This is the default setting.</para>
                    <figure>
                        <title>Syslog Protocol</title>
                        <mediaobject>
                            <imageobject role="html">
                                <imagedata format="PNG" fileref="win-syslog-protocol.png"/>
                            </imageobject>
                            <imageobject role="fo">
                                <imagedata format="PNG" fileref="&imgroot;/win-syslog-protocol.png" contentwidth="10cm"/>
                            </imageobject>
                        </mediaobject>
                    </figure>
                    <indexterm>
                        <primary>SDATA</primary>
                    </indexterm>
                    <indexterm>
                        <primary>sending macros in SDATA</primary>
                    </indexterm>
                    <indexterm>
                        <primary>metadata in SDATA</primary>
                    </indexterm>
                    <indexterm>
                        <primary>IETF-syslog protocol</primary>
                        <secondary>SDATA</secondary>
                    </indexterm>
                    <indexterm>
                        <primary>IETF-syslog protocol</primary>
                        <secondary>adding macros to SDATA</secondary>
                    </indexterm>
                    <!-- FIXME we should find a better place for this info, or structure the procedure differently -->
                    <para>When using the IETF-syslog protocol to transfer Eventlog messages, the &agentabbrev; application includes the macros (name-value pairs) in the SDATA part of the log message by default. This includes every available Event macro, except <parameter>EVENT_MSG (EVENT_MESSAGE)</parameter>, <parameter>EVENT_MSG_XML (EVENT_MESSAGE_XML)</parameter>. Macros that do not have a value will not be included in the message.</para>
                            <synopsis>499 &lt;132&gt;1 2010-09-28T12:02:30+02:00 zts-win004.ztswin2003dom.balabit testapp 1220 - [win@18372.4 EVENT_ID="1000" EVENT_NAME="Application" EVENT_REC_NUM="1673" EVENT_SID="S-1-5-21-3460971693-970282485-2299281428-1001" EVENT_SID_TYPE="User" EVENT_SOURCE="testapp" EVENT_TYPE="Warning" EVENT_USERNAME="ZTS-WIN004\\balabit"][meta sequenceId="1" sysUpTime="1"] ï»¿ZTS-WIN004\balabit: Application testapp: [Warning] test message (EventID 1000)</synopsis>
                            <note>
                                <para>The names of SDATA fields must be in the following format: name@&lt;private enterprise number&gt;, for example, <parameter>mySDATA-field@18372.4</parameter>. (18372.4 is the private enterprise number of BalaBit IT Security, the developer of &agent;.)</para>
                                <itemizedlist>
                                    <listitem>
                                        <para>Messages received from eventlog sources include the <parameter>win@18372.4</parameter> SD-ID. For example, on your &abbrev; server you can refer to message fields like: <parameter>${.SDATA.win@18372.4.EVENT_SOURCE}</parameter></para>
                                    </listitem>
                                    <listitem>
                                        <para>Messages received from eventlog sources include the <parameter>file@18372.4</parameter> SD-ID. For example, on your &abbrev; server you can refer to message fields like: <parameter>${.SDATA.file@18372.4.name}</parameter></para>
                                    </listitem>
                                </itemizedlist>
                            </note>
                    <para>To include only the data mandated by RFC5424, disable <guimenu>Include Eventlog message metadata as SDATA</guimenu>. To do this, navigate to <guimenu>Destinations > Destination Global Settings</guimenu>, select <guimenu>Enable</guimenu> and deselect <guimenu>Include Eventlog message metadata as SDATA</guimenu>. For example, only the following data will be included in the message:</para>
                    <synopsis>[meta sequenceId="value" sysUpTime="value"]</synopsis>
                </listitem>
                <listitem>
                    <indexterm>
                        <primary>snare</primary>
                    </indexterm>
                    <para><guimenu>Snare Protocol</guimenu>: Send log messages in a format compatible with the Snare log monitoring tool.</para>
                    <figure>
                        <title>Snare Protocol</title>
                        <mediaobject>
                            <imageobject role="html">
                                <imagedata format="PNG" fileref="win-snare-protocol.png"/>
                            </imageobject>
                            <imageobject role="fo">
                                <imagedata format="PNG" fileref="&imgroot;/win-snare-protocol.png" contentwidth="10cm"/>
                            </imageobject>
                        </mediaobject>
                    </figure>
                    <note>
                        <para>Snare is a tab-separated message format. Within the message part, agent replaces CRLF with 2 space, TAB character with 1 space.</para>
                        <para>You cannot modify the log format if you have selected this protocol.</para>
                    </note>
                    <example xml:id="example-snare-log">
                        <title>Snare log</title>
                        <synopsis>&lt;134&gt;Oct 06 13:49:41 zts-win019.ztswin2008dom.balabit MSWinEventLog   1   Application 1   Wed Oct 06 13:49:41 2010    1   syslog-ng Agent   S-1-5-21-551780264-1021859348-3425375765-1003   User    Information zts-win019.ztswin2008dom.balabit    None        Application started 1</synopsis>
                    </example>
                </listitem>
            </itemizedlist>
            <note>
                <para>Selecting the <guimenu>Syslog Protocol</guimenu> option is identical to using the <parameter>syslog</parameter> driver in the Linux/Unix version of syslog-ng. Similarly, selecting <guimenu>Legacy BSD Syslog Protocol</guimenu> is equivalent to the <parameter>tcp</parameter> driver of syslog-ng.</para>
                <para>Changing to the <guimenu>Legacy BSD Protocol</guimenu> does not automatically restore the original template. To do so, click <guimenu>Reset Protocol Template</guimenu> after modifying the protocol.</para>
            </note>
        </step>
        <step>
            <indexterm>
                <primary>message template</primary>
            </indexterm>
            <indexterm>
                <primary>message format</primary>
            </indexterm>
            <indexterm>
                <primary>formatting messages</primary>
            </indexterm>
            <para>If needed, modify the template of the messages. The format of the messages can be different for the eventlog and the file sources.</para>
            <warning>
                <para>The maximal length of the template is 1023 characters.</para>
            </warning>
        </step>
        <step>
            <indexterm>
                <primary>&agentabbrev;</primary>
                <secondary>failover servers</secondary>
            </indexterm>
            <indexterm>
                <primary>&agentabbrev;</primary>
                <secondary>client-side failover</secondary>
            </indexterm>
            <indexterm>
                <primary>client-side failover</primary>
                <secondary>&agentabbrev;</secondary>
            </indexterm>
            <para>If you have a backup server that can accept log messages if the primary log server becomes unavailable, select the <guimenu>Failover Servers</guimenu> tab, click <guimenu>Add</guimenu>, and enter the hostname or the IP address of the backup log server into the <guimenu>Server Name</guimenu> field. Repeat this step if you have more than one backup servers.</para>
            <figure>
                <title>Failover Servers</title>
                <mediaobject>
                    <imageobject role="html">
                        <imagedata format="PNG" fileref="win-server-property-failover.png"/>
                    </imageobject>
                    <imageobject role="fo">
                        <imagedata format="PNG" fileref="&imgroot;/win-server-property-failover.png" contentwidth="10cm"/>
                    </imageobject>
                </mediaobject>
            </figure>
        </step>
        <step>
            <para>If you want to send the log messages to more than on server in parallel, so that every server receives every message, repeat Steps 3-4 to add the other destination servers. These servers may have failover servers as well.</para>
        </step>
        <step>
            <para>Select <guimenu>Apply</guimenu>, then <guimenu>OK</guimenu>. To activate the changes, restart the &agentabbrev; service.</para>
        </step>
        <step>
            <indexterm>
                <primary>hostname resolution</primary>
            </indexterm>
            <indexterm>
                <primary>hostname in the messages</primary>
            </indexterm>
            <para><emphasis>Optional Step</emphasis>: If the host running &agentabbrev; is sometimes logged in into a domain, sometimes not, then its hostname might change depending on its actual domain membership. This can cause that the hostname appearing in the syslog messages depends on the domain membership of the host. To avoid this situation, select <guimenu>syslog-ng Agent Settings > Global Settings > Hostname > Use FQDN</guimenu>. That way &agentabbrev; resolves the name of its host from the DNS server, and uses the resolved FQDN in the syslog messages.</para>
        </step>
    </procedure>
    <procedure xml:id="windows-rate-limit">
        <title>Limiting the rate of messages</title>
        <indexterm>
            <primary>throttle</primary>
            <secondary>on Windows</secondary>
        </indexterm>
        <indexterm>
            <primary>message rate</primary>
            <secondary>on Windows</secondary>
        </indexterm>
        <indexterm>
            <primary>&agentabbrev;</primary>
            <secondary>throttle</secondary>
        </indexterm>
        <formalpara>
            <title>Purpose:</title>
            <para/>
        </formalpara>
        <para>The &agentabbrev; can control the rate of messages (message per second) sent to the central server. That way sudden message-bursts can be avoided, and the load of the server is decreased.</para>
        <para>To limit the number of messages sent to a destination, complete the following steps:</para>
        <formalpara>
            <title>Steps:</title>
            <para/>
        </formalpara>
        <step>
            <para>Start the configuration interface of the &agent; application.</para>
        </step>
        <step>
            <para>Select <guimenu>syslog-ng Agent Settings > Destinations</guimenu>.</para>
        </step>
        <step>
            <para>Select <guimenu>Destination Global Settings</guimenu>. To limit the number of messages that the &agentabbrev; sends to the server per second, enter the desired limit into the <guimenu>Throttle</guimenu> field. By default (<parameter>0</parameter>), the &agentabbrev; does not limit the number of messages sent.</para>
            <para>The throttling parameter applies to the total number of messages sent, not to every source independently. The same value applies to every destination.</para>
        </step>
        <step>
            <para>Click <guimenu>OK</guimenu>. To activate the changes, restart the &agentabbrev; service.</para>
        </step>
    </procedure>
    <procedure xml:id="windows-agent-mark-messages">
        <title>Sending MARK messages</title>
        <indexterm>
            <primary>MARK messages</primary>
            <secondary>configuring</secondary>
        </indexterm>
        <formalpara>
            <title>Purpose:</title>
            <para/>
        </formalpara>
        <para>If there are no new messages that have to be sent to the destination server, the &agent; application automatically sends a MARK message every ten minutes to notify the server that the connection is still active. The exact format of the MARK message depends on the protocol:</para>
        <formalpara>
            <title>Legacy BSD protocol (RFC3164):</title>
            <para><synopsis>&lt;46&gt;Apr 18 11:34:21 &lt;hostname&gt; -- MARK --</synopsis></para>
        </formalpara>
        <formalpara>
            <title>Snare protocol:</title>
            <para><synopsis>&lt;46&gt;Apr 18 11:34:21 &lt;hostname&gt; -- MARK --</synopsis></para>
        </formalpara>
        <formalpara>
            <title>Syslog protocol (RFC5424):</title>
            <para><synopsis>82 &lt;46&gt;1 2013-04-23T10:51:29+02:00 &lt;hostname&gt; - - - [meta sequenceId="3"] -- MARK --</synopsis></para>
        </formalpara>
        <para>To change how often the &agentabbrev; sends these messages, complete the following steps.</para>
        <formalpara>
            <title>Steps:</title>
            <para/>
        </formalpara>
        <step>
            <para>Start the configuration interface of the &agent; application.</para>
        </step>
        <step>
            <para>Select <guimenu>syslog-ng Agent Settings</guimenu> and double-click on <guimenu>Global Settings</guimenu>.</para>
        </step>
        <step>
            <para>Select <guimenu>Enable</guimenu>, then select <guimenu>Mark Mode Options</guimenu>.</para>
        </step>
        <step>
            <para>Set the frequency of MARK messages that the &agent; application sends.</para>
            <itemizedlist>
                <listitem>
                    <para><emphasis>Never</emphasis>: Do not send MARK messages.</para>
                </listitem>
                <listitem>
                    <para><emphasis>When destination idle</emphasis>: Send MARK messages only if there were no other messages sent to the destination during the specified period.</para>
                </listitem>
                <listitem>
                    <para><emphasis>Periodically</emphasis>: Send MARK messages every time the specified period expires.</para>
                </listitem>
            </itemizedlist>
        </step>
        <step>
            <para>Set the time between two MARK messages in the <guimenu>The number of seconds between two MARK messages</guimenu>. By default, this is 600 seconds (10 minutes).</para>
        </step>
        <step>
            <para>Select <guimenu>Apply</guimenu>, then <guimenu>OK</guimenu>. To activate the changes, restart the &agentabbrev; service.</para>
        </step>
    </procedure>
    <section xml:id="windows-agent-flow-control">
        <title>Flow-control in &agent;</title>
        <indexterm>
            <primary>flow-control</primary>
        </indexterm>
        <para>Starting with version 5 LTS, the flow-control feature of &product; is automatically enabled for the destinations. Using flow-control means that the &agentabbrev; will stop reading messages from the sources if the destination cannot accept them (for example, because of a network error). For details on the concepts of flow-control, see <olink targetdoc="syslog-ng-pe-guide-admin" targetptr="concepts-flow-control"/>.</para>
        <para>To enable or disable flow-control for a destination, select <guimenu>syslog-ng Agent Settings > Destinations</guimenu>, double-click on the destination, then select <guimenu>Server > Enable flow-control</guimenu>.</para>
        <xi:include href="../../common/wnt/note-windows-agent-rltp-flowcontrol.xml" xmlns:xi="http://www.w3.org/2001/XInclude"/>
        <note>
            <para>The flow-control of &agentabbrev; 5 LTS replaces the <guimenu>Primary Server</guimenu> option of earlier versions.</para>
        </note>

        <xi:include href="../../common/chunk/flow-control-multiple-destinations.xml" xmlns:xi="http://www.w3.org/2001/XInclude"/>
    </section>
</chapter>
