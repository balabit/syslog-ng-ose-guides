<?xml version="1.0" encoding="UTF-8"?>

 %entities;]&gt;
<html xmlns:MadCap="http://www.madcapsoftware.com/Schemas/MadCap.xsd"><body name="syslog-ng-source-osquery" oldrole="section">
<h1 name="syslog-ng-source-osquery" oldrole="section"><span class="Code" oldrole="parameter">osquery</span>: Collect and parse osquery result logs</h1>
<MadCap:keyword term="source drivers:[&lt;span class=&quot;Code&quot; oldrole=&quot;parameter&quot;&gt;osquery()&lt;/span&gt;, ' driver']"></MadCap:keyword>
<MadCap:keyword term="osquery"></MadCap:keyword>
<MadCap:keyword term="monitoring"></MadCap:keyword>
<p oldrole="para">The <a href="https://osquery.io">osquery</a> application allows you to ask questions about your machine using an SQL-like language. For example, you can query running processes, logged in users, installed packages and syslog messages as well. You can make queries on demand, and also schedule them to run regularly.</p>
<p oldrole="para">The <span class="Code" oldrole="parameter">osquery()</span> source of <entity>abbrev</entity> allows you read the results of periodical osquery queries (from the <span class="Code" oldrole="filename">/var/log/osquery/osqueryd.results.log</span> file) and automatically parse the messages (if you want to use <entity>abbrev</entity> to <a href="https://syslog-ng.com/blog/endpoint-visibility-and-monitoring-using-osquery-and-syslog-ng/">send log messages to osquery, read this blogpost</a>). For example, you can:</p>
<ul oldrole="itemizedlist">
<li oldrole="listitem">
<p oldrole="para">Create filters from the fields of the messages.</p>
</li>
<li oldrole="listitem">
<p oldrole="para">Limit which fields to store, or create additional fields (combine multiple fields into one field, and so on).</p>
</li>
<li oldrole="listitem">
<p oldrole="para">Send the messages to a central location, for example, to Elasticsearch, directly from <entity>abbrev</entity>.</p>
</li>
</ul>
<p oldrole="para">The <entity>abbrev</entity> application automatically adds the <span class="Code" oldrole="parameter">.osquery.</span> prefix to the name of the fields the extracted from the message.</p>
<p oldrole="para">The <span class="Code" oldrole="parameter">osquery()</span> source is available in <entity>abbrev</entity> version <phrase condition="ose">3.10</phrase><phrase condition="pe">7.0.4</phrase> and later.</p>

<h6 oldrole="formalpara">Prerequisites:</h6>
<p oldrole="para"></p>

<ul oldrole="itemizedlist">
<li oldrole="listitem">
<p oldrole="para">To use the <span class="Code" oldrole="parameter">osquery()</span> driver, the <span class="Code" oldrole="filename">scl.conf</span> file must be included in your <entity>abbrev</entity> configuration:</p>
<pre class="Code" oldrole="synopsis">@include "scl.conf"</pre>
</li>
<li condition="ose" oldrole="listitem">
<p oldrole="para"><entity>abbrev</entity> must be compiled with JSON-support enabled.</p>
</li>
</ul>
<p oldrole="para">The <span class="Code" oldrole="parameter">osquery()</span> driver is actually a reusable configuration snippet configured to read the osquery log file using the <span class="Code" oldrole="parameter">file()</span> driver, and process its JSON contents. For details on using or writing such configuration snippets, see <xref linkend="config-blocks"></xref>. You can find the source of this configuration snippet on <a href="https://github.com/balabit/syslog-ng/blob/master/scl/osquery/plugin.conf">GitHub</a>.</p>
<example xml:id="example-source-osquery">
<title>Using the osquery() driver with the default settings</title>
<p oldrole="para">The following <entity>abbrev</entity> configuration sample uses the default settings of the driver, reading osquery result logs from the <span class="Code" oldrole="filename">/var/log/osquery/osqueryd.results.log</span> file, and writes the log messages generated from the traps into a file.</p>
<pre class="Code" oldrole="synopsis">@version: 3.10
@include "scl.conf"
source s_osquery {
    osquery();
};
log {
    source(s_osquery);
    destination {
        file("/var/log/example.log");
    };
};</pre>
<p oldrole="para">Filter for messages related to loading Linux kernel modules:</p>
<pre class="Code" oldrole="synopsis">@version: 3.10
@include "scl.conf"
source s_osquery {
    osquery();
};
log {
    source(s_osquery);
    filter f_modules {
        "${.osquery.name}" eq "pack_incident-response_kernel_modules"
    };
    destination {
        file("/var/log/example.log");
    };
};</pre>
</example>
<example>
<title>Using the osquery() driver with custom configuration</title>
<p oldrole="para">The following <entity>abbrev</entity> configuration sample reads osquery result logs from the <span class="Code" oldrole="filename">/tmp/osquery_input.log</span> file, and writes the log messages generated from the traps into a file. Using the <span class="Code" oldrole="parameter">format-json</span> template, the outgoing message will be a well-formed JSON message.</p>

<h6 oldrole="formalpara">Input message:</h6>
<p oldrole="para"></p>

<pre class="Code" oldrole="synopsis">{"name":"pack_osquery-monitoring_osquery_info","hostIdentifier":"testhost","calendarTime":"Fri Jul 21 10:04:41 2017 UTC","unixTime":"1500631481","decorations":{"host_uuid":"4C4C4544-004D-3610-8043-C2C04F4D3332","username":"myuser"},"columns":{"build_distro":"xenial","build_platform":"ubuntu","config_hash":"43cd1c6a7d0c283e21e026a53e619b2e582e94ee","config_valid":"1","counter":"4","extensions":"active","instance_id":"d0c3eb0d-f8e0-4bea-868b-18a2c61b438d","pid":"19764","resident_size":"26416000","start_time":"1500629552","system_time":"223","user_time":"476","uuid":"4C4C4544-004D-3610-8043-C2C04F4D3332","version":"2.5.0","watcher":"19762"},"action":"added"}
</pre>

<h6 oldrole="formalpara"><entity>abbrev</entity> configuration:</h6>
<p oldrole="para"></p>

<pre class="Code" oldrole="synopsis">@version: 3.10
@include "scl.conf"
source s_osquery {
    osquery(
      file(/tmp/osquery_input.log)
      prefix(.osquery.)
    );
};
destination d_file {
    file(
      "/tmp/output.txt"
      template("$(format_json --key .osquery.*)\n")
    );
};
log {
  source(s_osquery);
  destination(d_file);
  flags(flow-control);
};</pre>

<h6 oldrole="formalpara">Outgoing message:</h6>
<p oldrole="para"></p>

<pre class="Code" oldrole="synopsis">Outgoing message; message='{"_osquery":{"unixTime":"1500631481","name":"pack_osquery-monitoring_osquery_info","hostIdentifier":"testhost","decorations":{"username":"myuser","host_uuid":"4C4C4544-004D-3610-8043-C2C04F4D3332"},"columns":{"watcher":"19762","version":"2.5.0","uuid":"4C4C4544-004D-3610-8043-C2C04F4D3332","user_time":"476","system_time":"223","start_time":"1500629552","resident_size":"26416000","pid":"19764","instance_id":"d0c3eb0d-f8e0-4bea-868b-18a2c61b438d","extensions":"active","counter":"4","config_valid":"1","config_hash":"43cd1c6a7d0c283e21e026a53e619b2e582e94ee","build_platform":"ubuntu","build_distro":"xenial"},"calendarTime":"Fri Jul 21 10:04:41 2017 UTC","action":"added"}}\x0a'
</pre>
</example>
<p oldrole="para">To configure a destination to send the log messages to Elasticsearch, see <xref linkend="configuring-destinations-elasticsearch2"></xref>. For other destinations, see <xref linkend="chapter-destinations"></xref>.</p>

<h2 name="reference-source-osquery">osquery() source options</h2>
<indexterm>
<primary>source drivers</primary>
<secondary><span class="Code" oldrole="parameter">osquery()</span> driver</secondary>
</indexterm>
<indexterm>
<primary>osquery</primary>
</indexterm>
<p oldrole="para">The <span class="Code" oldrole="parameter">osquery()</span> driver has the following options.</p>
<simplesect xml:id="osquery-file">
<title>file()</title>
<indexterm type="parameter">
<primary>file()</primary>
</indexterm>
<informaltable colsep="0" frame="topbot" rowsep="0">
<tgroup cols="2">
<colspec colnum="1" colwidth="40pt"></colspec>
<tbody>
<row>
<entry>Type: 
                                 </entry>
<entry>path</entry>
</row>
<row>
<entry>Default: 
                                 </entry>
<entry>/var/log/osquery/osqueryd.results.log</entry>
</row>
</tbody>
</tgroup>
</informaltable>
<p oldrole="para"><i oldrole="emphasis" role="bold">Description:</i> The log file of <b oldrole="command">osquery</b> that stores the results of periodic queries. The <entity>abbrev</entity> application reads the messages from this file.</p>
</simplesect>
<simplesect xml:id="osquery-prefix">
<MadCap:snippetBlock src="../../shared/chunk/option-parser-prefix.htm"></MadCap:snippetBlock>

<h6 oldrole="formalpara">Default value: </h6>
<p oldrole="para"></p>

<p oldrole="para"><span class="Code" oldrole="userinput">.osquery.</span> option.</p>
</simplesect>

</body></html>
